<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>WiFi Controller Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <style>
    body { background: #f8f9fa; padding: 40px; }
    .card { margin-bottom: 30px; }
    .qrcode { margin-top: 10px; }
    .qr-popup {
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 1000;
      min-width: 180px;
      min-height: 180px;
      visibility: hidden;
    }
    .qr-popup .close-btn {
      position: absolute;
      top: 4px;
      right: 6px;
      font-size: 1rem;
      color: #888;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      line-height: 1;
      transition: color 0.2s;
    }
    .qr-popup .close-btn:hover {
      color: #e22;
    }
    #ssidList li {
      position: relative;
    }
    #ssidForm.disabled input,
    #ssidForm.disabled select,
    #ssidForm.disabled button {
      pointer-events: none;
      opacity: 0.5;
    }
  </style>
</head>
<body>
<div class="container">
  <h2 class="mb-4">WiFi Controller Panel</h2>

  <div class="card mb-4">
    <div class="card-header">Wi-Fi Kartı Seç</div>
    <div class="card-body">
      <select id="wifiInterface" class="form-select" onchange="checkInterfaceSupport()">
        <option disabled selected>Yükleniyor…</option>
      </select>
      <div id="ifaceWarning" class="form-text text-danger mt-2"></div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">Tanımlı SSID'ler</div>
    <div class="card-body">
      <ul class="list-group" id="ssidList"></ul>
    </div>
  </div>

  <div class="card">
    <div class="card-header">Yeni SSID Ekle veya Düzenle</div>
    <div class="card-body" id="ssidForm">
      <div class="mb-3">
        <label class="form-label">SSID Adı</label>
        <input type="text" id="ssid" class="form-control">
      </div>
      <div class="mb-3">
        <label class="form-label">Parola</label>
        <input type="text" id="password" class="form-control">
      </div>
      <div class="mb-3">
        <label class="form-label">Yayın Durumu</label>
        <select id="enable" class="form-select">
          <option value="1">Aktif</option>
          <option value="0">Pasif</option>
        </select>
      </div>
      <button class="btn btn-success" onclick="handleAddSsid()">Ayarları Uygula</button>
      <button class="btn btn-secondary ms-2" onclick="cancelEdit()">İptal</button>
      <div id="newWifiMessage" class="mt-3"></div>
      <div id="qrcode" class="qrcode"></div>
    </div>
  </div>
</div>
<script>
let ssidList = [];
let ifaceSupportsMulti = false;

function fetchInterfaces() {
  fetch('/api/interfaces')
    .then(res => res.json())
    .then(data => {
      const sel = document.getElementById("wifiInterface");
      sel.innerHTML = '<option disabled selected>Wi-Fi kartı seçin</option>';
      data.interfaces.forEach(iface => {
        const opt = document.createElement('option');
        opt.value = iface;
        opt.textContent = iface;
        sel.appendChild(opt);
      });
    });
}

function checkInterfaceSupport() {
  const iface = document.getElementById("wifiInterface").value;
  fetch('/api/iface-support/' + iface)
    .then(res => res.json())
    .then(data => {
      const form = document.getElementById("ssidForm");
      const warning = document.getElementById("ifaceWarning");
      ifaceSupportsMulti = data.multi;

      const existing = ssidList.filter(i => i.iface === iface);
      if (!ifaceSupportsMulti && existing.length > 0) {
        form.classList.add("disabled");
        warning.textContent = `${iface} birden fazla SSID yayınını desteklemiyor.`;
      } else {
        form.classList.remove("disabled");
        warning.textContent = "";
      }
    });
}

function cancelEdit() {
  document.getElementById("ssid").value = "";
  document.getElementById("password").value = "";
  document.getElementById("enable").value = "1";
  document.getElementById("wifiInterface").value = "";
  document.getElementById("ssidForm").classList.remove("disabled");
  document.getElementById("ifaceWarning").textContent = "";
}

function fetchSsids() {
  fetch('/api/ssids')
    .then(res => res.json())
    .then(data => {
      ssidList = data.ssids;
      renderList();
    });
}

function renderList() {
  const ul = document.getElementById("ssidList");
  ul.innerHTML = '';
  if (!ssidList || ssidList.length === 0) {
    ul.innerHTML = `<li class="list-group-item">Henüz tanımlı SSID yok</li>`;
    return;
  }
  ssidList.forEach((item, index) => {
    const li = document.createElement("li");
    li.className = "list-group-item d-flex justify-content-between align-items-center";
    li.innerHTML = `
      <div><strong>${item.ssid}</strong> [${item.iface}] - ${item.enable == 1 ? "Aktif" : "Pasif"}</div>
      <div>
        <button class="btn btn-sm btn-primary" onclick="startEditSsid(${index})">Düzenle</button>
        <button class="btn btn-sm btn-secondary ms-2" onclick="showQrModal(this, '${item.ssid}', '${item.password}')">QR Göster</button>
        <button class="btn btn-sm btn-warning ms-2" onclick="alert('Parola: ${item.password}')">Parola Göster</button>
        <button class="btn btn-sm btn-danger ms-2" onclick="handleDeleteSsid(${index})">Sil</button>
      </div>`;
    ul.appendChild(li);
  });
}

function handleAddSsid() {
  const ssid = document.getElementById("ssid").value.trim();
  const password = document.getElementById("password").value.trim();
  const enable = document.getElementById("enable").value;
  const iface = document.getElementById("wifiInterface").value;

  if (!ssid || !password || !iface) return alert("Tüm alanlar zorunludur");
  fetch('/api/ssids', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ ssid, password, enable, iface })
  })
  .then(r => r.json())
  .then(() => {
    fetchSsids();
    cancelEdit();
  })
  .catch(e => alert("Ekleme hatası: " + e.message));
}

document.addEventListener("DOMContentLoaded", () => {
  fetchInterfaces();
  fetchSsids();
});
</script>
</body>
</html>
