<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>WiFi Controller Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <style>
    body { background: #f8f9fa; padding: 40px; }
    .card { margin-bottom: 30px; }
    .qrcode { margin-top: 10px; }

    .qr-popup {
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 1000;
      min-width: 180px;
      min-height: 180px;
      overflow: visible;
      visibility: hidden;
    }
    .qr-popup .close-btn {
      position: absolute;
      top: -8px;
      right: -8px;
      font-size: 1.2rem;
      color: #888;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      line-height: 1;
      transition: color 0.2s;
    }
    .qr-popup .close-btn:hover {
      color: #e22;
    }

    /* Düzenleme modundaki satır stili */
    .list-group-item-editing {
      background-color: #e9ecef;
      opacity: 0.7;
    }
  </style>
</head>
<body>

<div class="container">
  <h2 class="mb-4">WiFi Controller Panel</h2>

  <!-- Wi-Fi Kartı Seçimi -->
  <div class="card mb-4">
    <div class="card-header">Wi-Fi Kartı Seç</div>
    <div class="card-body">
      <select id="wifiInterface" class="form-select">
        <option disabled selected>Yükleniyor…</option>
      </select>
      <div id="interfaceWarning" class="text-danger mt-2"></div>
    </div>
  </div>

  <!-- Tanımlı SSID'ler -->
  <div class="card mb-4">
    <div class="card-header">Tanımlı SSID'ler</div>
    <div class="card-body">
      <ul class="list-group" id="ssidList"></ul>
    </div>
  </div>

  <!-- Yeni SSID Ekle / Düzenle -->
  <div class="card">
    <div class="card-header" id="formHeader">Yeni SSID Ekle veya Düzenle</div>
    <div class="card-body">
      <fieldset id="newSsidFieldset" disabled>
        <div class="mb-3">
          <label class="form-label">SSID Adı</label>
          <input type="text" id="ssid" class="form-control">
        </div>
        <div class="mb-3">
          <label class="form-label">Parola</label>
          <input type="text" id="password" class="form-control">
        </div>
        <div class="mb-3">
          <label class="form-label">VLAN ID</label>
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="noVlanCheckbox" checked onchange="toggleVlanDisable()">
            <label class="form-check-label" for="noVlanCheckbox">VLAN yok</label>
          </div>
          <select id="vlanSelect" class="form-select" disabled onchange="toggleVlanInput()">
            <option disabled selected>Lütfen VLAN seçiniz</option>
          </select>
          <div id="vlanCustomGroup" class="row mt-2" style="display: none;">
            <div class="col">
              <input type="text" id="vlanCustomId" class="form-control" placeholder="VLAN ID">
            </div>
            <div class="col">
              <input type="text" id="vlanCustomDesc" class="form-control" placeholder="Açıklama">
            </div>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">Yayın Durumu</label>
          <select id="enable" class="form-select">
            <option value="1">Aktif</option>
            <option value="0">Pasif</option>
          </select>
        </div>
        <button id="applyBtn" class="btn btn-success" onclick="handleAddSsid()">Ayarları Uygula</button>
        <button id="cancelBtn" class="btn btn-secondary ms-2" onclick="cancelEdit()" style="display:none">İptal</button>
      </fieldset>

      <div id="newWifiMessage" class="mt-3"></div>
      <div id="qrcode" class="qrcode"></div>
    </div>
  </div>
</div>

<script>
  let ssidList = [];
  let isEditing = false;
  let editingIndex = null;

  document.addEventListener("DOMContentLoaded", () => {
    fetchInterfaces();
    fetchSsids();
    document.getElementById("wifiInterface")
            .addEventListener("change", handleInterfaceChange);
    disableForm();
    handleInterfaceChange();    // ← başlangıçta da mutlaka pasif kalsın
  });

  /*** API Çağrıları ***/
  function fetchInterfaces() {
    fetch('/api/interfaces')
      .then(res => res.json())
      .then(data => {
        const sel = document.getElementById("wifiInterface");
        sel.innerHTML = '';
        sel.appendChild(new Option('Lütfen Wi-Fi kartı seçin','',true,true));
        data.interfaces.forEach(iface => {
          sel.appendChild(new Option(iface, iface));
        });
      });
  }

  function fetchSsids() {
    fetch('/api/ssids')
      .then(res => res.json())
      .then(data => {
        ssidList = data.ssids;
        renderList();
        populateVlanOptions();
        handleInterfaceChange(); // yeniden kontrol et
      });
  }

  /*** Listeyi Çiz ***/
  function renderList() {
    const ul = document.getElementById("ssidList");
    ul.innerHTML = '';

    if (!ssidList.length) {
      const li = document.createElement("li");
      li.className = "list-group-item d-flex justify-content-between align-items-center";
      li.innerHTML = `<div class="fst-italic text-muted">Henüz tanımlı SSID yok</div><div></div>`;
      ul.appendChild(li);
      return;
    }

    ssidList.forEach((item, idx) => {
      const li = document.createElement("li");
      li.className = "list-group-item d-flex justify-content-between align-items-center";
      li.innerHTML = `
        <div>
          <strong>${item.ssid}</strong> (VLAN: ${item.vlan}) [${item.enable==1 ? "Aktif":"Pasif"}] (Kart: ${item.iface})
        </div>
        <div>
          <button class="btn btn-sm btn-primary me-2" onclick="startEditSsid(${idx})">Düzenle</button>
          <button class="btn btn-sm btn-secondary me-2" onclick="showQrModal(this,'${item.ssid}','${item.password}')">QR Göster</button>
          <button class="btn btn-sm btn-warning me-2" onclick="alert('Parola: ${item.password}')">Parola Göster</button>
          <button class="btn btn-sm btn-danger" onclick="handleDeleteSsid(${idx})">Sil</button>
        </div>`;
      if (isEditing && idx === editingIndex) {
        li.classList.add("list-group-item-editing");
        li.querySelectorAll("button").forEach(b=>b.disabled=true);
      }
      ul.appendChild(li);
    });
  }

  /*** Yeni/Düzenle İşlemleri ***/
  function handleAddSsid() {
    const ssidInput = document.getElementById("ssid").value.trim();
    const password = document.getElementById("password").value.trim();
    const iface = document.getElementById("wifiInterface").value;
    let vlan = "";
    if (document.getElementById("noVlanCheckbox").checked) {
      vlan = "Yok";
    } else {
      vlan = document.getElementById("vlanSelect").value;
      if (vlan==="custom") {
        const id = document.getElementById("vlanCustomId").value.trim();
        const desc = document.getElementById("vlanCustomDesc").value.trim();
        if(!id||!desc){ alert("Özel VLAN boş olamaz!"); return; }
        vlan = `${id} - ${desc}`;
      }
    }
    const enable = document.getElementById("enable").value;

    if (!ssidInput||!password||!iface) {
      alert("SSID, parola ve kart seçimi zorunlu!");
      return;
    }
    const dup = ssidList.some((it,i)=>
      it.ssid.toLowerCase()===ssidInput.toLowerCase() &&
      !(isEditing && i===editingIndex)
    );
    if (dup) {
      alert(`"${ssidInput}" zaten kayıtlı!`);
      return;
    }

    const payload = { ssid:ssidInput, password, vlan, enable, iface };
    fetch('/api/ssids', {
      method: 'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    })
    .then(r=> r.ok ? r.json() : r.json().then(e=>{throw new Error(e.error)}))
    .then(_=>{
      fetchSsids();
      const msg = isEditing
        ? `<strong>${ssidInput}</strong> güncellendi.`
        : `<strong>${ssidInput}</strong> eklendi.`;
      document.getElementById("newWifiMessage").innerHTML =
        `<div class="alert alert-light border-secondary p-2">${msg}</div>`;
      generateQr(ssidInput,password,"qrcode");
      cancelEdit();
    })
    .catch(e=>alert("Hata: "+e.message));
  }

  function startEditSsid(idx) {
    isEditing=true; editingIndex=idx;
    const it = ssidList[idx];
    document.getElementById("ssid").value = it.ssid;
    document.getElementById("password").value = it.password;
    document.getElementById("enable").value = it.enable;
    document.getElementById("wifiInterface").value = it.iface;
    if (it.vlan!=="Yok") {
      document.getElementById("noVlanCheckbox").checked=false;
      toggleVlanDisable();
      populateVlanOptions();
      const sel= document.getElementById("vlanSelect");
      sel.value = Array.from(sel).some(o=>o.value===it.vlan) ? it.vlan : "custom";
      toggleVlanInput();
      if (it.vlan.includes(" - ")) {
        const [i,d]=it.vlan.split(" - ");
        document.getElementById("vlanCustomId").value=i;
        document.getElementById("vlanCustomDesc").value=d;
      }
    } else {
      document.getElementById("noVlanCheckbox").checked=true;
      toggleVlanDisable();
    }
    document.getElementById("formHeader").textContent = "SSID Düzenle";
    document.getElementById("applyBtn").textContent = "Güncelle";
    document.getElementById("cancelBtn").style.display = "inline-block";
    enableForm();
    renderList();
  }

  function cancelEdit() {
    isEditing=false; editingIndex=null;
    document.getElementById("formHeader").textContent = "Yeni SSID Ekle veya Düzenle";
    document.getElementById("applyBtn").textContent = "Ayarları Uygula";
    document.getElementById("cancelBtn").style.display = "none";
    document.getElementById("ssid").value = "";
    document.getElementById("password").value = "";
    document.getElementById("noVlanCheckbox").checked = true;
    toggleVlanDisable();
    document.getElementById("enable").value = "1";
    document.getElementById("wifiInterface").value = "";
    document.getElementById("newWifiMessage").innerHTML = "";
    document.getElementById("qrcode").innerHTML = "";
    renderList();
    disableForm();
  }

  function handleDeleteSsid(idx) {
    fetch(`/api/ssids/${idx}`,{method:'DELETE'})
      .then(r=> r.ok ? fetchSsids() : r.json().then(e=>{throw new Error(e.error)}))
      .catch(e=>alert("Silme hatası: "+e.message));
  }

  /*** QR ***/
  function generateQr(ssid, password, target) {
    const d = document.getElementById(target);
    d.innerHTML = "";
    new QRCode(d, {
      text: `WIFI:T:WPA;S:${ssid};P:${password};;`,
      width:180, height:180
    });
  }
  function showQrModal(btn, ssid, password) {
    closeAnyPopup();
    const li = btn.closest("li");
    const popup = document.createElement("div");
    popup.className = "qr-popup";
    const closeBtn = document.createElement("button");
    closeBtn.className = "close-btn";
    closeBtn.innerHTML = "&times;";
    closeBtn.onclick = ()=>popup.remove();
    const qrC = document.createElement("div");
    popup.appendChild(closeBtn);
    popup.appendChild(qrC);
    li.appendChild(popup);
    new QRCode(qrC, {
      text: `WIFI:T:WPA;S:${ssid};P:${password};;`,
      width:180, height:180
    });
    const br = btn.getBoundingClientRect(), lr = li.getBoundingClientRect();
    popup.style.top  = `${br.bottom - lr.top + 6}px`;
    popup.style.left = `${br.left - lr.left}px`;
    popup.style.visibility = "visible";
  }
  function closeAnyPopup(){ document.querySelectorAll(".qr-popup").forEach(x=>x.remove()); }

  /*** VLAN ***/
  function toggleVlanDisable() {
    const sel = document.getElementById("vlanSelect"),
          grp = document.getElementById("vlanCustomGroup"),
          chk = document.getElementById("noVlanCheckbox");
    if (chk.checked) {
      sel.disabled = true;
      sel.innerHTML = `<option disabled selected>Lütfen VLAN seçiniz</option>`;
      grp.style.display = "none";
    } else {
      sel.disabled = false;
      populateVlanOptions();
    }
  }
  function toggleVlanInput() {
    const sel = document.getElementById("vlanSelect"),
          grp = document.getElementById("vlanCustomGroup");
    if (sel.value==="custom") grp.style.display="flex";
    else { grp.style.display="none"; grp.querySelectorAll("input").forEach(i=>i.value=""); }
  }
  function populateVlanOptions() {
    const sel = document.getElementById("vlanSelect");
    if (sel.disabled) return;
    sel.innerHTML = `<option disabled selected>Lütfen VLAN seçiniz</option>`;
    ["10","20","30"].forEach(v=>{
      sel.appendChild(new Option(v,v));
    });
    sel.appendChild(new Option("Özel VLAN","custom"));
  }

  /*** Formu aktifle/pasifleştir ***/
  function disableForm(){ document.getElementById("newSsidFieldset").disabled = true; }
  function enableForm(){ document.getElementById("newSsidFieldset").disabled = false; }

  /*** Kart seçimi sonrası ***/
  function handleInterfaceChange() {
    const iface = document.getElementById("wifiInterface").value;
    const warn = document.getElementById("interfaceWarning");
    warn.textContent = "";
    if (!iface) {
      disableForm(); return;
    }
    if (isEditing) {
      enableForm(); return;
    }
    const taken = ssidList.some(it=>it.iface === iface);
    if (taken) {
      warn.textContent = "Bu cihaz aynı anda yalnızca 1 SSID yayınına izin veriyor veya bu karta zaten atanmış SSID var.";
      disableForm();
    } else {
      enableForm();
    }
  }
</script>

</body>
</html>
